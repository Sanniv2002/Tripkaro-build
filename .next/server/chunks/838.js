"use strict";exports.id=838,exports.ids=[838],exports.modules={28516:(e,t,a)=>{a.d(t,{F9:()=>n,Ig:()=>o,LA:()=>d,Ls:()=>s,VS:()=>c,a5:()=>i}),a(70391),a(53009);var r=a(61324),n=(0,r.$)("27789748d4028595e8f7c4f335d85448c4eb53ad"),i=(0,r.$)("db7e1d758c705a2e3689b038b7253fafa458c5cd"),s=(0,r.$)("6875be3eb71c47789351b1ab13a7f89fc0f02960"),o=(0,r.$)("519527161853f61403e27d0e4fedaddf7716aac6"),c=(0,r.$)("ce63b2e88fe9f05aae1cdf2555fa938e6e894aa6"),d=(0,r.$)("f6068f201973c2497e9a34d1821ef41ced4dd163")},97798:(e,t,a)=>{a.r(t),a.d(t,{addTrip:()=>p,fetchTrips:()=>u,getTimeline:()=>m,getTripDetails:()=>h,getTripName:()=>w,joinRoom:()=>f});var r=a(57016),n=a(77728),i=a(88490),s=a(9901),o=a(69568),c=a(54064),d=a(96276);let l="true"===process.env.ENABLE_CACHE;async function u(){let e=await (0,s.getServerSession)(o.authOptions);if(!e?.user?.id)throw Error("User not authenticated");let t=`user:${e.user.id}:trips`;try{if(l){let e=await i.default.get(t);if(e)return JSON.parse(e)}let a=await n.default.trip.findMany({where:{participants:{some:{id:e.user.id}}},include:{participants:!0,expenses:!0}}),r=a.reduce((e,t)=>e+t.expenses.reduce((e,t)=>e+t.amount,0),0),s=a.filter(e=>e.startDate<=new Date&&(null===e.endDate||e.endDate>=new Date)),o=a.reduce((e,t)=>e+t.participants.length,0),c=s.reduce((e,t)=>e+t.expenses.reduce((e,t)=>e+t.amount,0),0),d=a.length>0?r/a.length:0,u=s.length>0?c/s.length:0,p={trips:a,activeTrips:s,metrics:{totalExpense:r,activeTripsCount:s.length,totalParticipants:o,averageCostPerTrip:d,averageCostPerActiveTrip:u}};return l&&await i.default.set(t,JSON.stringify(p),"EX",600),p}catch(e){throw console.error("Error fetching trips:",e),Error("Unable to fetch trips")}}async function p(e){let t=await (0,s.getServerSession)(o.authOptions);if(!t?.user?.id)throw Error("User not authenticated");try{let a=function(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let a=0;a<6;a++){let a=Math.floor(Math.random()*e.length);t+=e[a]}return t}(),r=new Date(e.startDate),s=e.endDate?new Date(e.endDate):null,o=await n.default.trip.create({data:{name:e.name,description:e.description,startDate:r,endDate:s,participants:{connect:{id:t.user.id}},roomCode:a}}),c={content:`${t.user.viewName} just created a new trip! ✈️🌍`,avatar:t.user.avatar,userId:t.user.id};return await n.default.timeline.create({data:{message:c,trip:{connect:{id:o.id}}}}),l&&await i.default.del(`user:${t.user.id}:trips`),o}catch(e){throw console.error("Error adding trip:",e),Error("Unable to create trip")}}async function f(e){let t=await (0,s.getServerSession)(o.authOptions);if(!t?.user?.id)throw Error("User not authenticated");try{let a=await n.default.trip.findUnique({where:{roomCode:e}});if(!a)throw Error("Invalid room code");l&&await i.default.del(`trip:${a.id}:details`);let r=await n.default.trip.findFirst({where:{id:a.id,participants:{some:{id:t.user.id}}}});if(r)throw Error("You are already a participant in this trip");let s=await n.default.trip.update({where:{id:a.id},data:{participants:{connect:{id:t.user.id}}}}),o={content:`${t.user.viewName} just joined the adventure! 🚀`,avatar:t.user.avatar,userId:t.user.id};await n.default.timeline.create({data:{message:o,trip:{connect:{id:s.id}}}});let c={tripId:s.id,message:o};return fetch("https://events-tripkaro-production.up.railway.app/send-notification",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),l&&await i.default.del(`user:${t.user.id}:trips`),{success:!0,message:"Joined room successfully",trip:a}}catch(e){throw console.error("Error joining room:",e),Error(e.message||"Unable to join room")}}async function h(e){let t=await (0,s.getServerSession)(o.authOptions);if(!t?.user?.id)throw Error("User not authenticated");let a=`trip:${e}:details`;try{if(l){let e=await i.default.get(a);if(e){console.log("Returning trip details from cache:",a);let r=JSON.parse(e);return r.userId=t.user.id,r}}let r=await n.default.trip.findUnique({where:{id:e},include:{participants:!0,expenses:{include:{user:{select:{viewName:!0,avatar:!0}}}}}});if(!r)throw Error("Trip not found");let s=r.participants.length;if(0===s)throw Error("No participants found for the trip");let o=r.participants.map(e=>{let t=r.expenses.filter(t=>t.userId===e.id).reduce((e,t)=>e+t.amount,0);return{name:e.viewName,avatar:e.avatar,spent:t}}),d=r.expenses.reduce((e,t)=>e+t.amount,0),u=(0,c.calculateSettlements)(d,o),p={},f=0,h=0;r.participants.forEach(e=>{p[e.id]=0}),r.expenses.forEach(e=>{let t=r.participants.filter(t=>e.userId===t.id||e.userId),a=t.length===s,n=e.amount/s;a&&(f+=e.amount,h++),r.participants.forEach(t=>{t.id===e.userId?p[t.id]+=e.amount-n:p[t.id]-=n})});let{participants:m,expenses:w,...g}=r,v={userId:t?.user?.id,trip:g,totalExpense:d,participants:r.participants,expenses:r.expenses.map(e=>({...e,creatorName:e.user?.viewName||"Unknown",creatorAvatar:e.user?.avatar})),perPerson:h>0?f/s:0,settlements:u};return l&&await i.default.set(a,JSON.stringify(v),"EX",600),v}catch(e){throw console.error("Error fetching trip details:",e),Error("Unable to fetch trip details")}}async function m(e){let t=await (0,s.getServerSession)(o.authOptions);if(!t?.user?.id)throw Error("User not authenticated");try{let t=await n.default.timeline.findMany({where:{tripId:e},orderBy:{createdAt:"asc"}});return t}catch(e){throw console.error("Error fetching timeline:",e),Error("Failed to fetch timeline")}}async function w(e){try{let t=await n.default.trip.findUnique({where:{roomCode:e}});if(!t)throw Error("Invalid room code");return t}catch(e){throw Error(e.message)}}(0,d.ensureServerEntryExports)([u,p,f,h,m,w]),(0,r.createActionProxy)("27789748d4028595e8f7c4f335d85448c4eb53ad",null,u),(0,r.createActionProxy)("db7e1d758c705a2e3689b038b7253fafa458c5cd",null,p),(0,r.createActionProxy)("6875be3eb71c47789351b1ab13a7f89fc0f02960",null,f),(0,r.createActionProxy)("519527161853f61403e27d0e4fedaddf7716aac6",null,h),(0,r.createActionProxy)("ce63b2e88fe9f05aae1cdf2555fa938e6e894aa6",null,m),(0,r.createActionProxy)("f6068f201973c2497e9a34d1821ef41ced4dd163",null,w)},77728:(e,t,a)=>{a.d(t,{default:()=>i});var r=a(53524);let n=globalThis.prismaGlobal??new r.PrismaClient,i=n},69568:(e,t,a)=>{a.d(t,{authOptions:()=>s});var r=a(77728),n=a(42851);let i=["https://cdn-icons-png.flaticon.com/512/8318/8318047.png","https://cdn-icons-png.flaticon.com/512/2424/2424348.png","https://cdn-icons-png.flaticon.com/512/6807/6807923.png","https://cdn-icons-png.flaticon.com/256/4819/4819571.png","https://cdn-icons-png.flaticon.com/512/1998/1998592.png","https://cdn-icons-png.flaticon.com/512/3069/3069172.png","https://cdn-icons-png.flaticon.com/512/1089/1089472.png","https://cdn-icons-png.flaticon.com/512/2153/2153090.png","https://cdn-icons-png.flaticon.com/512/3886/3886682.png"],s={providers:[(0,n.default)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})],secret:process.env.JWT_SECRET||"secret",callbacks:{async session({token:e,session:t}){let a=await r.default.user.findUnique({where:{email:e.email||t.user.email}});return a?(t.user.id=a.id,t.user.viewName=a.viewName,t.user.avatar=a.avatar):console.log("User not found in the database"),t},async signIn({account:e,profile:t}){let a=i[Math.floor(Math.random()*i.length)];if(e?.provider==="google"){if(!t?.email)throw Error("No email found in the profile");return await r.default.user.upsert({where:{email:t.email},create:{name:t.name||"Unnamed User",email:t.email,viewName:t.name?.split(" ")[0]||"User",avatar:a},update:{name:t.name}}),!0}return!1}},pages:{signIn:"/signin"}}},54064:(e,t,a)=>{a.d(t,{calculateSettlements:()=>r});function r(e,t){let a=t.length,r=e/a,n=[],i=t.map(e=>({name:e.name,balance:e.spent-r,avatar:e.avatar})),s=i.filter(e=>e.balance>0).sort((e,t)=>t.balance-e.balance),o=i.filter(e=>e.balance<0).sort((e,t)=>e.balance-t.balance);for(;s.length>0&&o.length>0;){let e=s[0],t=o[0],a=Math.min(e.balance,-t.balance);n.push({from:t.name,to:e.name,amount:a,fromAvatar:t.avatar,toAvatar:e.avatar}),e.balance-=a,t.balance+=a,0===e.balance&&s.shift(),0===t.balance&&o.shift()}return n}},88490:(e,t,a)=>{let r;a.d(t,{default:()=>o});var n=a(62025),i=a.n(n);let s="true"===process.env.ENABLE_CACHE;s&&(r=new(i())({host:process.env.REDIS_HOST||"127.0.0.1",port:Number(process.env.REDIS_PORT)||6379,password:process.env.REDIS_PASSWORD||void 0}));let o=r}};